/******************************************************************************
 ******************************************************************************
 **                                                                          **
 **                          ファイルヘッダー                                  **
 **                          File: switch.cpp                                **
 **                                                                          **
 ******************************************************************************
 ******************************************************************************/

/******************************************************************************
 *                                                                            *
 *                              ライブラリ読み込み                             *
 *                                                                            *
 ******************************************************************************/
#include "d_switch.h"

#include "../../bsw/io/b_io_t.h"
#include "../../constants/constant.h"
#include "../../hal/arduino/h_arduino.h"

/******************************************************************************
 *                                                                            *
 *                              内部定数                                      *
 *                                                                            *
 ******************************************************************************/

/*============================================================================*
 *                            デバウンス設定                                   *
 *============================================================================*/
#define DEBOUNCE_DELAY_MS 50

/******************************************************************************
 *                                                                            *
 *                              内部型定義                                    *
 *                                                                            *
 ******************************************************************************/

/*============================================================================*
 *                            スイッチコンテキスト構造体                       *
 *============================================================================*/
typedef struct {
  int pin;                        /* ピン番号 */
  bool stableState;               /* 安定した状態 */
  bool lastReadState;             /* 前回の読み取り状態 */
  unsigned long lastDebounceTime; /* デバウンス用タイマー */
} switch_ctx_t;

/******************************************************************************
 *                                                                            *
 *                              内部関数プロトタイプ                           *
 *                                                                            *
 ******************************************************************************/
static global_err_t switchDebounce(switch_ctx_t* switchCtx);

/******************************************************************************
 *                                                                            *
 *                              スイッチ初期化関数                             *
 *                                                                            *
 ******************************************************************************/
static global_err_t switchInit(void* ctx) {
  /*----------------------------------------------------------------------------*
   *                          NULLチェック                                      *
   *----------------------------------------------------------------------------*/
  if (ctx == nullptr) {
    return GLOBAL_ERR_INVALID_PARAM;
  }

  switch_ctx_t* switchCtx = static_cast<switch_ctx_t*>(ctx);

  /*----------------------------------------------------------------------------*
   *                          HAL初期化                                         *
   *----------------------------------------------------------------------------*/
  halPinMode(switchCtx->pin, HAL_PIN_MODE_INPUT_PULLUP);
  bool initialState = false;
  halDigitalRead(switchCtx->pin, &initialState);

  /*----------------------------------------------------------------------------*
   *                          初期状態読み取り                                  *
   *----------------------------------------------------------------------------*/
  switchCtx->stableState = initialState;
  switchCtx->lastReadState = initialState;
  halMillis(&switchCtx->lastDebounceTime);

  return GLOBAL_OK;
}

/******************************************************************************
 *                                                                            *
 *                              スイッチ状態取得関数                           *
 *                                                                            *
 ******************************************************************************/
static global_err_t switchGet(void* ctx, bool* out) {
  /*----------------------------------------------------------------------------*
   *                          NULLチェック                                      *
   *----------------------------------------------------------------------------*/
  if (ctx == nullptr || out == nullptr) {
    return GLOBAL_ERR_INVALID_PARAM;
  }

  switch_ctx_t* switchCtx = static_cast<switch_ctx_t*>(ctx);

  *out = switchCtx->stableState;

  return GLOBAL_OK;
}

/******************************************************************************
 *                                                                            *
 *                              スイッチポーリング関数                         *
 *                                                                            *
 ******************************************************************************/
static global_err_t switchPoll(void* ctx) {
  /*----------------------------------------------------------------------------*
   *                          NULLチェック                                      *
   *----------------------------------------------------------------------------*/
  if (ctx == nullptr) {
    return GLOBAL_ERR_INVALID_PARAM;
  }

  switch_ctx_t* switchCtx = static_cast<switch_ctx_t*>(ctx);

  /*----------------------------------------------------------------------------*
   *                          現在状態読み取り                                  *
   *----------------------------------------------------------------------------*/
  bool currentReadState = false;
  halDigitalRead(switchCtx->pin, &currentReadState);

  unsigned long currentTime = 0;
  halMillis(&currentTime);

  /*----------------------------------------------------------------------------*
   *                          デバウンス処理                                    *
   *----------------------------------------------------------------------------*/
  if (currentReadState != switchCtx->lastReadState) {
    switchCtx->lastDebounceTime = currentTime;
  }

  /*............................................................................*
   *                          安定状態更新                                     *
   *............................................................................*/
  if ((currentTime - switchCtx->lastDebounceTime) > DEBOUNCE_DELAY_MS) {
    if (currentReadState != switchCtx->stableState) {
      switchCtx->stableState = currentReadState;
    }
  }

  /*----------------------------------------------------------------------------*
   *                          最終読み取り状態更新                              *
   *----------------------------------------------------------------------------*/
  switchCtx->lastReadState = currentReadState;

  return GLOBAL_OK;
}

/******************************************************************************
 *                                                                            *
 *                              内部変数                                      *
 *                                                                            *
 ******************************************************************************/

/*============================================================================*
 *                            スイッチコンテキスト実体                         *
 *============================================================================*/
switch_ctx_t switchCtx;

/*============================================================================*
 *                            スイッチ操作関数テーブル                         *
 *============================================================================*/
bio_input_device_ops_t switchOps = {
    .init = switchInit,
    .get = switchGet,
    .poll = switchPoll,
};

/******************************************************************************
 *                                                                            *
 *                              スイッチデバイス生成関数                       *
 *                                                                            *
 ******************************************************************************/
bio_input_device_t* createSwitchInputDevice(int pin, bio_input_tag_t tag) {
  /*----------------------------------------------------------------------------*
   *                          コンテキスト設定                                  *
   *----------------------------------------------------------------------------*/
  switchCtx.pin = pin;

  /*----------------------------------------------------------------------------*
   *                          デバイス生成                                      *
   *----------------------------------------------------------------------------*/
  return new bio_input_device_t{
      .tag = tag,
      .ctx = &switchCtx,
      .ops = &switchOps,
  };
}