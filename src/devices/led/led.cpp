/******************************************************************************
 ******************************************************************************
 **                                                                          **
 **                          ファイルヘッダー                                  **
 **                          File: led.cpp                                   **
 **                                                                          **
 ******************************************************************************
 ******************************************************************************/

/******************************************************************************
 *                                                                            *
 *                              ライブラリ読み込み                             *
 *                                                                            *
 ******************************************************************************/
#include "led.h"

#include "../../bsw/io/b_io_t.h"
#include "../../constants/constant.h"
#include "../../hal/arduino/hal_arduino.h"

/******************************************************************************
 *                                                                            *
 *                              内部型定義                                    *
 *                                                                            *
 ******************************************************************************/

/*============================================================================*
 *                            LEDコンテキスト構造体                            *
 *============================================================================*/
typedef struct {
  int pin;        /* ピン番号 */
  bool state;     /* LED状態 */
  bool lastState; /* 最後に設定したLED状態 */
} led_ctx_t;

/******************************************************************************
 *                                                                            *
 *                              LED初期化関数                                  *
 *                                                                            *
 ******************************************************************************/
static global_err_t ledInit(void* ctx) {
  /*----------------------------------------------------------------------------*
   *                          NULLチェック                                      *
   *----------------------------------------------------------------------------*/
  if (ctx == nullptr) {
    return GLOBAL_ERR_INVALID_PARAM;
  }

  led_ctx_t* ledCtx = static_cast<led_ctx_t*>(ctx);

  /*----------------------------------------------------------------------------*
   *                          HAL初期化                                         *
   *----------------------------------------------------------------------------*/
  halPinMode(ledCtx->pin, HAL_PIN_MODE_OUTPUT);
  halDigitalWrite(ledCtx->pin, false);

  /*----------------------------------------------------------------------------*
   *                          初期状態設定                                      *
   *----------------------------------------------------------------------------*/
  ledCtx->state = false;
  ledCtx->lastState = false;

  return GLOBAL_OK;
}

/******************************************************************************
 *                                                                            *
 *                              LED状態設定関数                                *
 *                                                                            *
 ******************************************************************************/
static global_err_t ledSet(void* ctx, bool value) {
  /*----------------------------------------------------------------------------*
   *                          NULLチェック                                      *
   *----------------------------------------------------------------------------*/
  if (ctx == nullptr) {
    return GLOBAL_ERR_INVALID_PARAM;
  }

  led_ctx_t* ledCtx = static_cast<led_ctx_t*>(ctx);

  /*----------------------------------------------------------------------------*
   *                          状態更新判定                                      *
   *----------------------------------------------------------------------------*/
  if (ledCtx->lastState != ledCtx->state) {
    halDigitalWrite(ledCtx->pin, ledCtx->state);
    ledCtx->lastState = ledCtx->state;
  }

  return GLOBAL_OK;
}

/******************************************************************************
 *                                                                            *
 *                              内部変数                                      *
 *                                                                            *
 ******************************************************************************/

/*============================================================================*
 *                            LEDコンテキスト実体                              *
 *============================================================================*/
static led_ctx_t ledCtx;

/*============================================================================*
 *                            LED操作関数テーブル                              *
 *============================================================================*/
const static bio_output_device_ops_t ledOps = {
    .init = ledInit,
    .set = ledSet,
};

/******************************************************************************
 *                                                                            *
 *                              LEDデバイス生成関数                            *
 *                                                                            *
 ******************************************************************************/
bio_output_device_t* createLedOutputDevice(int pin, bio_output_tag_t tag) {
  return new bio_output_device_t{
      .tag = tag,
      .ctx = &ledCtx,
      .ops = &ledOps,
  };
}