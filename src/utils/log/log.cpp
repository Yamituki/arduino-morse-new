/******************************************************************************
 ******************************************************************************
 **                                                                          **
 **                          ファイルヘッダー                                  **
 **                          File: log.cpp                                   **
 **                                                                          **
 ******************************************************************************
 ******************************************************************************/

/******************************************************************************
 *                                                                            *
 *                              ライブラリ読み込み                             *
 *                                                                            *
 ******************************************************************************/
#include "log.h"

#include <Arduino.h>
#include <Arduino_FreeRTOS.h>
#include <semphr.h>
#include <stdarg.h>
#include <string.h>

#include "../../constants/constant.h"

/******************************************************************************
 *                                                                            *
 *                              内部定数                                      *
 *                                                                            *
 ******************************************************************************/

/*============================================================================*
 *                            シリアル通信設定                                *
 *============================================================================*/
static constexpr unsigned long LOG_BAUD_RATE = 115200;

/*============================================================================*
 *                         ミューテックス設定                                  *
 *============================================================================*/
static SemaphoreHandle_t logMutex;
static SemaphoreHandle_t logFormatMutex;

/*============================================================================*
 *                            バッファサイズ設定                              *
 *============================================================================*/
static const size_t MESSAGE_BUFFER_SIZE = 256;
static const size_t LABEL_BUFFER_SIZE = 16;
static const size_t TIMESTAMP_BUFFER_SIZE = 16;
static const size_t TASKNAME_BUFFER_SIZE = 32;
static const size_t FILELINE_BUFFER_SIZE = 64;

/*============================================================================*
 *                            ANSIカラーコード配列                            *
 *============================================================================*/
static const char* ANSIColorCodes[] = {
    "\033[0m",   // RESET
    "\033[30m",  // BLACK
    "\033[31m",  // RED
    "\033[32m",  // GREEN
    "\033[33m",  // YELLOW
    "\033[34m",  // BLUE
    "\033[35m",  // MAGENTA
    "\033[36m",  // CYAN
    "\033[37m",  // WHITE
    "\033[90m",  // BRIGHT_BLACK
    "\033[91m",  // BRIGHT_RED
    "\033[92m",  // BRIGHT_GREEN
    "\033[93m",  // BRIGHT_YELLOW
    "\033[94m",  // BRIGHT_BLUE
    "\033[95m",  // BRIGHT_MAGENTA
    "\033[96m",  // BRIGHT_CYAN
    "\033[97m"   // BRIGHT_WHITE
};

/******************************************************************************
 *                                                                            *
 *                              内部型定義                                    *
 *                                                                            *
 ******************************************************************************/

/*============================================================================*
 *                            ログ情報構造体                                  *
 *============================================================================*/
typedef struct {
  const char* name;
  const char* colorCode;
} Log_t;

/******************************************************************************
 *                                                                            *
 *                              内部変数                                      *
 *                                                                            *
 ******************************************************************************/

/*============================================================================*
 *                            状態変数                                        *
 *============================================================================*/
static bool isInitialized = false;
static LogLevel_t currentLogLevel = LOG_INFO;

/*============================================================================*
 *                            ログ定義配列                                    *
 *============================================================================*/
static Log_t Loggers[] = {
    {"ERROR  ", ANSIColorCodes[RED]},
    {"WARNING", ANSIColorCodes[YELLOW]},
    {"INFO   ", ANSIColorCodes[GREEN]},
    {"DEBUG  ", ANSIColorCodes[CYAN]},
};

/******************************************************************************
 *                                                                            *
 *                              内部関数プロトタイプ                           *
 *                                                                            *
 ******************************************************************************/
static void print(const char* color, const char* message);
static const char* getLogTimestamp(void);
static const char* getLogLevelLabel(LogLevel_t level);
static const char* getTaskName(void);
static const char* getFileAndLineNumber(const char* file, int line);

/******************************************************************************
 *                                                                            *
 *                              初期化関数                                     *
 *                                                                            *
 ******************************************************************************/
global_err_t logInit(void) {
  /*----------------------------------------------------------------------------*
   *                          二重初期化防止                                  *
   *----------------------------------------------------------------------------*/
  if (isInitialized) {
    return GLOBAL_OK;
  }

  /*----------------------------------------------------------------------------*
   *                          シリアル通信初期化                                *
   *----------------------------------------------------------------------------*/
  Serial.begin(LOG_BAUD_RATE);

  /*----------------------------------------------------------------------------*
   *                          ミューテックス初期化                              *
   *----------------------------------------------------------------------------*/
  logMutex = xSemaphoreCreateMutex();
  if (logMutex == NULL) {
    return GLOBAL_ERR_INITIALIZATION_FAILED;
  }

  logFormatMutex = xSemaphoreCreateMutex();
  if (logFormatMutex == NULL) {
    return GLOBAL_ERR_INITIALIZATION_FAILED;
  }

  /*----------------------------------------------------------------------------*
   *                          初期化完了                                        *
   *----------------------------------------------------------------------------*/
  isInitialized = true;

  return GLOBAL_OK;
}

/******************************************************************************
 *                                                                            *
 *                              ログレベル設定関数                             *
 *                                                                            *
 ******************************************************************************/
global_err_t logSetLevel(LogLevel_t level) {
  currentLogLevel = level;
  return GLOBAL_OK;
}

/******************************************************************************
 *                                                                            *
 *                              ログ色設定関数                                 *
 *                                                                            *
 ******************************************************************************/
global_err_t logSetColorCodeWithLevel(LogLevel_t level, ANSIColorCode_t colorCode) {
  Loggers[level].colorCode = ANSIColorCodes[colorCode];
  return GLOBAL_OK;
}

/******************************************************************************
 *                                                                            *
 *                              ログ出力関数                                   *
 *                                                                            *
 ******************************************************************************/
void logPrint(LogLevel_t level, const char* file, int line, const char* message) {
  /*----------------------------------------------------------------------------*
   *                          初期化チェック                                    *
   *----------------------------------------------------------------------------*/
  if (!isInitialized) {
    return;
  }

  /*----------------------------------------------------------------------------*
   *                          ログレベル判定                                    *
   *----------------------------------------------------------------------------*/
  if (level > currentLogLevel) {
    return;
  }

  /*----------------------------------------------------------------------------*
   *                          ミューテックス取得                                *
   *----------------------------------------------------------------------------*/
  if (xSemaphoreTake(logMutex, portMAX_DELAY) != pdTRUE) {
    return;
  }

  /*----------------------------------------------------------------------------*
   *                          ログ出力                                          *
   *----------------------------------------------------------------------------*/
  print(ANSIColorCodes[MAGENTA], getLogTimestamp());
  print(Loggers[level].colorCode, getLogLevelLabel(level));
  print(ANSIColorCodes[BLUE], getTaskName());
  print(ANSIColorCodes[BRIGHT_BLACK], getFileAndLineNumber(file, line));
  print(ANSIColorCodes[RESET], message);
  print(ANSIColorCodes[RESET], "\n");

  /*----------------------------------------------------------------------------*
   *                          ログ出力待ち                                      *
   *----------------------------------------------------------------------------*/
  Serial.flush();

  /*----------------------------------------------------------------------------*
   *                          ミューテックス解放                                *
   *----------------------------------------------------------------------------*/
  xSemaphoreGive(logMutex);
}

/******************************************************************************
 *                                                                            *
 *                              フォーマット付きログ出力関数                    *
 *                                                                            *
 ******************************************************************************/
void logPrintFormat(LogLevel_t level, const char* file, int line, const char* format, ...) {
  /*----------------------------------------------------------------------------*
   *                         ミューテックス取得                                *
   *----------------------------------------------------------------------------*/
  if (xSemaphoreTake(logFormatMutex, portMAX_DELAY) != pdTRUE) {
    return;
  }

  /*----------------------------------------------------------------------------*
   *                          可変引数処理                                      *
   *----------------------------------------------------------------------------*/
  va_list args;
  va_start(args, format);
  static char message[MESSAGE_BUFFER_SIZE];
  vsnprintf(message, sizeof(message), format, args);
  va_end(args);

  /*----------------------------------------------------------------------------*
   *                          ログ出力                                          *
   *----------------------------------------------------------------------------*/
  logPrint(level, file, line, message);

  /*----------------------------------------------------------------------------*
   *                          ミューテックス解放                                *
   *----------------------------------------------------------------------------*/
  xSemaphoreGive(logFormatMutex);
}

/******************************************************************************
 *                                                                            *
 *                              内部プリント関数                               *
 *                                                                            *
 ******************************************************************************/
static void print(const char* color, const char* message) {
  Serial.print(color);
  Serial.print(message);
}

/******************************************************************************
 *                                                                            *
 *                              ログレベルラベル取得関数                        *
 *                                                                            *
 ******************************************************************************/
static const char* getLogLevelLabel(LogLevel_t level) {
  static char label[LABEL_BUFFER_SIZE];
  sprintf(label, "[%s] ", Loggers[level].name);
  return label;
}

/******************************************************************************
 *                                                                            *
 *                              タイムスタンプ取得関数                          *
 *                                                                            *
 ******************************************************************************/
static const char* getLogTimestamp(void) {
  /*----------------------------------------------------------------------------*
   *                          時間計算                                          *
   *----------------------------------------------------------------------------*/
  unsigned long ms = millis();
  unsigned long seconds = ms / 1000;
  unsigned long minutes = seconds / 60;
  unsigned long hours = minutes / 60;

  unsigned long displayMs = ms % 1000;
  unsigned long displaySeconds = seconds % 60;
  unsigned long displayMinutes = minutes % 60;
  unsigned long displayHours = hours % 24;

  /*----------------------------------------------------------------------------*
   *                          フォーマット生成                                  *
   *----------------------------------------------------------------------------*/
  static char timestamp[TIMESTAMP_BUFFER_SIZE];
  sprintf(timestamp, "[%02lu:%02lu:%02lu.%03lu] ", displayHours, displayMinutes, displaySeconds,
          displayMs);
  return timestamp;
}

/******************************************************************************
 *                                                                            *
 *                              タスク名取得関数                               *
 *                                                                            *
 ******************************************************************************/
static const char* getTaskName(void) {
  /*----------------------------------------------------------------------------*
   *                          タスクハンドル取得                                *
   *----------------------------------------------------------------------------*/
  TaskHandle_t currentTask = xTaskGetCurrentTaskHandle();
  static char taskNameFormatted[TASKNAME_BUFFER_SIZE];

  /*----------------------------------------------------------------------------*
   *                          タスク名フォーマット                              *
   *----------------------------------------------------------------------------*/
  const char* taskName = pcTaskGetName(currentTask);
  sprintf(taskNameFormatted, "[%s] ", taskName);

  return taskNameFormatted;
}

/******************************************************************************
 *                                                                            *
 *                              ファイル・行番号取得関数                        *
 *                                                                            *
 ******************************************************************************/
static const char* getFileAndLineNumber(const char* file, int line) {
  /*----------------------------------------------------------------------------*
   *                          プロジェクトルート以降のパス取得                  *
   *----------------------------------------------------------------------------*/
  const char* path = strstr(file, PROJECT_ROOT_DIR);
  path = (path != NULL) ? path + strlen(PROJECT_ROOT_DIR) : file;

  /*----------------------------------------------------------------------------*
   *                          表示パス決定（末尾2階層）                         *
   *----------------------------------------------------------------------------*/
  const char* lastSlash = strrchr(path, '/');
  const char* displayPath = path;

  if (lastSlash != NULL) {
    /*............................................................................*
     *                          2つ目のスラッシュ検索                             *
     *............................................................................*/
    const char* secondLastSlash = lastSlash - 1;
    while (secondLastSlash >= path && *secondLastSlash != '/') {
      secondLastSlash--;
    }
    if (secondLastSlash >= path) {
      displayPath = secondLastSlash + 1;
    }
  }

  /*----------------------------------------------------------------------------*
   *                          フォーマット生成                                  *
   *----------------------------------------------------------------------------*/
  static char fileLine[FILELINE_BUFFER_SIZE];
  sprintf(fileLine, "[%s:%d] ", displayPath, line);
  return fileLine;
}