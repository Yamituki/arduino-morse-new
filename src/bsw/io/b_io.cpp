/******************************************************************************
 ******************************************************************************
 **                                                                          **
 **                          ファイルヘッダー                                  **
 **                          File: b_io.cpp                                  **
 **                                                                          **
 ******************************************************************************
 ******************************************************************************/

/******************************************************************************
 *                                                                            *
 *                              ライブラリ読み込み                             *
 *                                                                            *
 ******************************************************************************/
#include "b_io.h"

#include "../../constants/constant.h"
#include "../../interfaces/i_io_t.h"

/******************************************************************************
 *                                                                            *
 *                              内部定数                                      *
 *                                                                            *
 ******************************************************************************/

/*============================================================================*
 *                            デバイス数上限                                   *
 *============================================================================*/
#define MAX_INPUT_DEVICES 1
#define MAX_OUTPUT_DEVICES 2

/******************************************************************************
 *                                                                            *
 *                              内部型定義                                    *
 *                                                                            *
 ******************************************************************************/

/*============================================================================*
 *                            出力デバイスエントリ構造体                       *
 *============================================================================*/
typedef struct {
  const output_device_t* device;
  bool desired;
} OutputDeviceEntry_t;

/******************************************************************************
 *                                                                            *
 *                              内部変数                                      *
 *                                                                            *
 ******************************************************************************/

/*============================================================================*
 *                            入力デバイス配列                                 *
 *============================================================================*/
const static input_device_t* inputDevices[MAX_INPUT_DEVICES] = {0};

/*============================================================================*
 *                            出力デバイス配列                                 *
 *============================================================================*/
static OutputDeviceEntry_t outputDevicePool[MAX_OUTPUT_DEVICES] = {0};
static OutputDeviceEntry_t* outputDevices[MAX_OUTPUT_DEVICES] = {0};

/*============================================================================*
 *                            配列長定義                                       *
 *============================================================================*/
#define INPUT_DEVICES_LENGTH (sizeof(inputDevices) / sizeof(inputDevices[0]))
#define OUTPUT_DEVICES_LENGTH (sizeof(outputDevices) / sizeof(outputDevices[0]))

/******************************************************************************
 *                                                                            *
 *                              BSW_インプット取得処理関数                     *
 *                                                                            *
 ******************************************************************************/
void bIOInputProcess() {}

/******************************************************************************
 *                                                                            *
 *                              BSW_アウトプット設定処理関数                   *
 *                                                                            *
 ******************************************************************************/
void bIOOutputProcess() {
  /*----------------------------------------------------------------------------*
   *                          全出力デバイス走査                                *
   *----------------------------------------------------------------------------*/
  for (int i = 0; i < OUTPUT_DEVICES_LENGTH; i++) {
    OutputDeviceEntry_t* entry = outputDevices[i];
    if (entry && entry->device) {
      entry->device->ops->set(entry->device->ctx, entry->desired);
    }
  }
}

/******************************************************************************
 *                                                                            *
 *                              入力デバイス登録関数                           *
 *                                                                            *
 ******************************************************************************/
global_err_t bIORegisterInputDevice(input_device_t* device) {
  inputDevices[device->tag] = device;
  return GLOBAL_OK;
}

/******************************************************************************
 *                                                                            *
 *                              出力デバイス登録関数                           *
 *                                                                            *
 ******************************************************************************/
global_err_t bIORegisterOutputDevice(output_device_t* device) {
  /*----------------------------------------------------------------------------*
   *                          静的配列からエントリ取得                          *
   *----------------------------------------------------------------------------*/
  OutputDeviceEntry_t* entry = &outputDevicePool[device->tag];
  entry->device = device;
  entry->desired = false;
  outputDevices[device->tag] = entry;

  return GLOBAL_OK;
}

/******************************************************************************
 *                                                                            *
 *                              入力デバイス状態取得関数                       *
 *                                                                            *
 ******************************************************************************/
global_err_t bIOGetInputState(input_tag_t tag, void* out) {
  /*----------------------------------------------------------------------------*
   *                          デバイス取得                                      *
   *----------------------------------------------------------------------------*/
  const input_device_t* device = inputDevices[tag];

  /*----------------------------------------------------------------------------*
   *                          NULLチェック                                      *
   *----------------------------------------------------------------------------*/
  if (device == nullptr) {
    return GLOBAL_ERR_INVALID_PARAM;
  }

  return device->ops->get((void*)device->ctx, out);
}

/******************************************************************************
 *                                                                            *
 *                              出力デバイス状態設定関数                       *
 *                                                                            *
 ******************************************************************************/
global_err_t bIOSetOutputState(output_tag_t tag, bool value) {
  /*----------------------------------------------------------------------------*
   *                          エントリ取得                                      *
   *----------------------------------------------------------------------------*/
  OutputDeviceEntry_t* entry = outputDevices[tag];

  /*----------------------------------------------------------------------------*
   *                          NULLチェック                                      *
   *----------------------------------------------------------------------------*/
  if (entry == nullptr || entry->device == nullptr) {
    return GLOBAL_ERR_INVALID_PARAM;
  }

  /*----------------------------------------------------------------------------*
   *                          望ましい状態設定                                  *
   *----------------------------------------------------------------------------*/
  entry->desired = value;

  return GLOBAL_OK;
}